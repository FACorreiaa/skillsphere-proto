syntax = "proto3";

package skillsphere.chat.v1;

import "google/protobuf/timestamp.proto";
import "common/v1/common.proto";
import "buf/validate/validate.proto";

option go_package = "github.com/FACorreiaa/skillsphere-proto/gen/go/chat/v1;chatv1";

// ChatService handles real-time messaging between users
service ChatService {
  // Send a message
  rpc SendMessage(SendMessageRequest) returns (SendMessageResponse);

  // Get chat history
  rpc GetMessages(GetMessagesRequest) returns (GetMessagesResponse);

  // Stream messages in real-time (server streaming for WebSocket-like behavior)
  rpc StreamMessages(StreamMessagesRequest) returns (stream StreamMessagesResponse);

  // Mark messages as read
  rpc MarkAsRead(MarkAsReadRequest) returns (MarkAsReadResponse);

  // List user conversations
  rpc ListConversations(ListConversationsRequest) returns (ListConversationsResponse);

  // Delete message
  rpc DeleteMessage(DeleteMessageRequest) returns (DeleteMessageResponse);

  // React to message (emoji reactions)
  rpc ReactToMessage(ReactToMessageRequest) returns (ReactToMessageResponse);

  // Report message
  rpc ReportMessage(ReportMessageRequest) returns (ReportMessageResponse);
}

// ============================================================================
// Message Types
// ============================================================================

enum MessageType {
  MESSAGE_TYPE_UNSPECIFIED = 0;
  MESSAGE_TYPE_TEXT = 1;
  MESSAGE_TYPE_IMAGE = 2;
  MESSAGE_TYPE_FILE = 3;
  MESSAGE_TYPE_SYSTEM = 4;              // System notifications
}

message Message {
  string message_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string conversation_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string sender_id = 3 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string recipient_id = 4 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  MessageType type = 5 [
    (buf.validate.field).enum.defined_only = true
  ];
  string content = 6 [                  // Text or file URL
    (buf.validate.field).string.max_len = 5000
  ];
  repeated skillsphere.common.v1.Attachment attachments = 7 [
    (buf.validate.field).repeated.max_items = 10
  ];
  google.protobuf.Timestamp sent_at = 8;
  google.protobuf.Timestamp read_at = 9;
  bool is_read = 10;
  bool is_deleted = 11;
  repeated Reaction reactions = 12 [
    (buf.validate.field).repeated.max_items = 100
  ];
}

message Reaction {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string emoji = 2 [                    // Unicode emoji
    (buf.validate.field).string.max_len = 8
  ];
  google.protobuf.Timestamp created_at = 3;
}

message Conversation {
  string conversation_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  repeated string participant_ids = 2 [
    (buf.validate.field).repeated = {
      min_items: 2
      max_items: 20
    },
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
  Message last_message = 3;
  int32 unread_count = 4 [
    (buf.validate.field).int32.gte = 0
  ];
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
  bool is_archived = 7;
}

// ============================================================================
// Send Message
// ============================================================================

message SendMessageRequest {
  string sender_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string recipient_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string conversation_id = 3 [          // Optional for new conversations
    (buf.validate.field).string.max_len = 50
  ];
  MessageType type = 4 [
    (buf.validate.field).enum.defined_only = true
  ];
  string content = 5 [
    (buf.validate.field).string.max_len = 5000
  ];
  repeated skillsphere.common.v1.Attachment attachments = 6 [
    (buf.validate.field).repeated.max_items = 10
  ];
}

message SendMessageResponse {
  Message message = 1;
  string conversation_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
}

// ============================================================================
// Get Messages
// ============================================================================

message GetMessagesRequest {
  string conversation_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  int32 page_size = 2 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 200
    }
  ];
  string page_token = 3 [
    (buf.validate.field).string.max_len = 256
  ];
  google.protobuf.Timestamp since = 4;  // Get messages after this time
}

message GetMessagesResponse {
  repeated Message messages = 1;
  string next_page_token = 2 [
    (buf.validate.field).string.max_len = 256
  ];
}

// ============================================================================
// Stream Messages
// ============================================================================

message StreamMessagesRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  repeated string conversation_ids = 2 [ // Empty for all conversations
    (buf.validate.field).repeated.max_items = 50,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
}

message StreamMessagesResponse {
  Message message = 1;
  string event_type = 2 [               // "new_message", "message_read", "typing"
    (buf.validate.field).string = {
      min_len: 1
      max_len: 32
    }
  ];
  TypingIndicator typing = 3;           // Optional
}

message TypingIndicator {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string conversation_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  bool is_typing = 3;
}

// ============================================================================
// Mark As Read
// ============================================================================

message MarkAsReadRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  repeated string message_ids = 2 [
    (buf.validate.field).repeated.max_items = 200,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
  string conversation_id = 3 [          // Mark all in conversation
    (buf.validate.field).string.max_len = 50
  ];
}

message MarkAsReadResponse {
  int32 marked_count = 1 [
    (buf.validate.field).int32.gte = 0
  ];
}

// ============================================================================
// List Conversations
// ============================================================================

message ListConversationsRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  int32 page_size = 2 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 100
    }
  ];
  string page_token = 3 [
    (buf.validate.field).string.max_len = 256
  ];
  bool unread_only = 4;
}

message ListConversationsResponse {
  repeated Conversation conversations = 1;
  string next_page_token = 2 [
    (buf.validate.field).string.max_len = 256
  ];
}

// ============================================================================
// Delete Message
// ============================================================================

message DeleteMessageRequest {
  string message_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string user_id = 2 [                  // For authorization
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
}

message DeleteMessageResponse {
  bool success = 1;
}

// ============================================================================
// React To Message
// ============================================================================

message ReactToMessageRequest {
  string message_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string user_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string emoji = 3 [
    (buf.validate.field).string.max_len = 8
  ];
}

message ReactToMessageResponse {
  Reaction reaction = 1;
}

// ============================================================================
// Report Message
// ============================================================================

message ReportMessageRequest {
  string message_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reporter_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reason = 3 [
    (buf.validate.field).string.max_len = 200
  ];
  string description = 4 [
    (buf.validate.field).string.max_len = 1000
  ];
}

message ReportMessageResponse {
  string report_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string status = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 32
    }
  ];
}
