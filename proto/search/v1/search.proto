syntax = "proto3";

package skillsphere.search.v1;

import "google/protobuf/timestamp.proto";
import "common/v1/common.proto";
import "buf/validate/validate.proto";

option go_package = "github.com/FACorreiaa/skillsphere-proto/gen/go/search/v1;searchv1";

// SearchService provides discovery and search functionality
service SearchService {
  // Search for users by skills, location, etc.
  rpc SearchUsers(SearchUsersRequest) returns (SearchUsersResponse);

  // Search for skills by keyword or category
  rpc SearchSkills(SearchSkillsRequest) returns (SearchSkillsResponse);

  // Get trending skills
  rpc GetTrendingSkills(GetTrendingSkillsRequest) returns (GetTrendingSkillsResponse);

  // Get featured users (curated by admins)
  rpc GetFeaturedUsers(GetFeaturedUsersRequest) returns (GetFeaturedUsersResponse);

  // Get skill recommendations based on search history
  rpc GetSearchSuggestions(GetSearchSuggestionsRequest) returns (GetSearchSuggestionsResponse);

  // Advanced search with multiple filters
  rpc AdvancedSearch(AdvancedSearchRequest) returns (AdvancedSearchResponse);
}

// ============================================================================
// Search Users
// ============================================================================

message SearchUsersRequest {
  string query = 1 [                    // Keyword search (name, bio, skills)
    (buf.validate.field).string.max_len = 200
  ];
  skillsphere.common.v1.SearchFilters filters = 2;
  int32 page_size = 3 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 50
    }
  ];
  string page_token = 4 [
    (buf.validate.field).string.max_len = 256
  ];
  SearchSortBy sort_by = 5 [
    (buf.validate.field).enum.defined_only = true
  ];
}

enum SearchSortBy {
  SEARCH_SORT_BY_UNSPECIFIED = 0;
  SEARCH_SORT_BY_RELEVANCE = 1;
  SEARCH_SORT_BY_RATING = 2;
  SEARCH_SORT_BY_SESSIONS = 3;
  SEARCH_SORT_BY_DISTANCE = 4;
  SEARCH_SORT_BY_RECENT = 5;
}

message SearchUsersResponse {
  repeated UserSearchResult results = 1;
  string next_page_token = 2;
  int32 total_count = 3;
  SearchMetadata metadata = 4;
}

message UserSearchResult {
  skillsphere.common.v1.User user = 1;
  double relevance_score = 2 [          // 0.0-1.0
    (buf.validate.field).double = {
      gte: 0
      lte: 1
    }
  ];
  repeated string matched_skills = 3 [
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 100
      }
    }
  ];
  string snippet = 4 [                  // Highlighted text snippet
    (buf.validate.field).string.max_len = 500
  ];
  double distance_km = 5 [              // If geo-search enabled
    (buf.validate.field).double = {
      gte: 0
      lte: 20000
    }
  ];
}

message SearchMetadata {
  int32 query_time_ms = 1 [
    (buf.validate.field).int32.gte = 0
  ];
  string query_id = 2 [                 // For analytics
    (buf.validate.field).string.max_len = 50
  ];
  repeated string applied_filters = 3 [
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 100
      }
    }
  ];
}

// ============================================================================
// Search Skills
// ============================================================================

message SearchSkillsRequest {
  string query = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 200
    }
  ];
  repeated skillsphere.common.v1.SkillCategory categories = 2 [
    (buf.validate.field).repeated.max_items = 10
  ];
  int32 limit = 3 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 50
    }
  ];
}

message SearchSkillsResponse {
  repeated SkillSearchResult results = 1;
}

message SkillSearchResult {
  skillsphere.common.v1.Skill skill = 1;
  double relevance_score = 2 [
    (buf.validate.field).double = {
      gte: 0
      lte: 1
    }
  ];
  int32 user_count = 3 [                // How many users have this skill
    (buf.validate.field).int32.gte = 0
  ];
  bool is_trending = 4;
}

// ============================================================================
// Get Trending Skills
// ============================================================================

message GetTrendingSkillsRequest {
  int32 limit = 1 [                     // Default 10, max 50
    (buf.validate.field).int32 = {
      gte: 1
      lte: 50
    }
  ];
  skillsphere.common.v1.SkillCategory category = 2;
  int32 days = 3 [                      // Trending window (default 7)
    (buf.validate.field).int32 = {
      gte: 1
      lte: 30
    }
  ];
  string region = 4 [                   // Optional geographic filter
    (buf.validate.field).string.max_len = 100
  ];
}

message GetTrendingSkillsResponse {
  repeated TrendingSkill skills = 1;
  google.protobuf.Timestamp computed_at = 2;
}

message TrendingSkill {
  skillsphere.common.v1.Skill skill = 1;
  int32 trend_score = 2 [(buf.validate.field).int32.gte = 0];
  int32 sessions_count = 3 [(buf.validate.field).int32.gte = 0];
  double growth_rate = 4 [              // Percentage
    (buf.validate.field).double = {
      gte: -100
      lte: 100
    }
  ];
  int32 rank = 5 [                      // Position in trending list
    (buf.validate.field).int32 = {
      gte: 1
      lte: 1000
    }
  ];
}

// ============================================================================
// Get Featured Users
// ============================================================================

message GetFeaturedUsersRequest {
  int32 limit = 1 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 50
    }
  ];
  skillsphere.common.v1.SkillCategory category = 2;
}

message GetFeaturedUsersResponse {
  repeated FeaturedUser users = 1;
}

message FeaturedUser {
  skillsphere.common.v1.User user = 1;
  string feature_reason = 2 [           // Why they're featured
    (buf.validate.field).string.max_len = 200
  ];
  string badge = 3 [                    // e.g., "Top Contributor", "Expert"
    (buf.validate.field).string.max_len = 50
  ];
}

// ============================================================================
// Get Search Suggestions
// ============================================================================

message GetSearchSuggestionsRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string partial_query = 2 [            // Autocomplete query
    (buf.validate.field).string = {
      min_len: 1
      max_len: 100
    }
  ];
  int32 limit = 3 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 20
    }
  ];
}

message GetSearchSuggestionsResponse {
  repeated Suggestion suggestions = 1;
}

message Suggestion {
  string text = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 100
    }
  ];
  string type = 2 [                     // "skill", "user", "category"
    (buf.validate.field).string = {
      min_len: 1
      max_len: 32
    }
  ];
  int32 popularity = 3 [
    (buf.validate.field).int32.gte = 0
  ];
}

// ============================================================================
// Advanced Search
// ============================================================================

message AdvancedSearchRequest {
  SearchQuery query = 1;
  int32 page_size = 2 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 50
    }
  ];
  string page_token = 3 [
    (buf.validate.field).string.max_len = 256
  ];
}

message SearchQuery {
  // User filters
  repeated string skill_ids_offered = 1 [
    (buf.validate.field).repeated.max_items = 50,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
  repeated string skill_ids_wanted = 2 [
    (buf.validate.field).repeated.max_items = 50,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
  skillsphere.common.v1.ProficiencyLevel min_proficiency = 3 [
    (buf.validate.field).enum.defined_only = true
  ];

  // Location filters
  skillsphere.common.v1.Location location = 4;
  int32 max_distance_km = 5 [
    (buf.validate.field).int32 = {
      gte: 0
      lte: 20000
    }
  ];

  // Availability filters
  repeated skillsphere.common.v1.DayOfWeek available_days = 6 [
    (buf.validate.field).repeated.max_items = 7
  ];
  string timezone = 7 [
    (buf.validate.field).string.max_len = 100
  ];

  // Rating filters
  double min_rating = 8 [
    (buf.validate.field).double = {
      gte: 0
      lte: 5
    }
  ];
  int32 min_sessions = 9 [
    (buf.validate.field).int32 = {
      gte: 0
      lte: 1000
    }
  ];

  // Subscription filters
  skillsphere.common.v1.SubscriptionTier min_tier = 10 [
    (buf.validate.field).enum.defined_only = true
  ];
  bool verified_only = 11;
}

message AdvancedSearchResponse {
  repeated UserSearchResult results = 1;
  string next_page_token = 2;
  int32 total_count = 3;
  SearchMetadata metadata = 4;
}
