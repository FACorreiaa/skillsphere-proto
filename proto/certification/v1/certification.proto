syntax = "proto3";

package skillsphere.certification.v1;

import "google/protobuf/timestamp.proto";
import "common/v1/common.proto";
import "buf/validate/validate.proto";

option go_package = "github.com/FACorreiaa/skillsphere-proto/gen/go/certification/v1;certificationv1";

// CertificationService manages blockchain-based skill certifications and badges
service CertificationService {
  // Issue certification/badge after session completion
  rpc IssueCertification(IssueCertificationRequest) returns (IssueCertificationResponse);

  // Verify certification authenticity
  rpc VerifyCertification(VerifyCertificationRequest) returns (VerifyCertificationResponse);

  // Get user certifications
  rpc GetUserCertifications(GetUserCertificationsRequest) returns (GetUserCertificationsResponse);

  // Revoke certification
  rpc RevokeCertification(RevokeCertificationRequest) returns (RevokeCertificationResponse);

  // Get certification details
  rpc GetCertification(GetCertificationRequest) returns (GetCertificationResponse);

  // Share certification (generate shareable link)
  rpc ShareCertification(ShareCertificationRequest) returns (ShareCertificationResponse);

  // Mint NFT badge (blockchain)
  rpc MintNFTBadge(MintNFTBadgeRequest) returns (MintNFTBadgeResponse);

  // Get available badge templates
  rpc GetBadgeTemplates(GetBadgeTemplatesRequest) returns (GetBadgeTemplatesResponse);
}

// ============================================================================
// Enums
// ============================================================================

enum CertificationType {
  CERTIFICATION_TYPE_UNSPECIFIED = 0;
  CERTIFICATION_TYPE_SKILL_COMPLETION = 1;   // Completed skill exchange
  CERTIFICATION_TYPE_EXPERT_VERIFIED = 2;    // Verified by expert
  CERTIFICATION_TYPE_MILESTONE = 3;          // Platform milestone (e.g., 100 sessions)
  CERTIFICATION_TYPE_ACHIEVEMENT = 4;        // Special achievement badge
}

enum BlockchainNetwork {
  BLOCKCHAIN_NETWORK_UNSPECIFIED = 0;
  BLOCKCHAIN_NETWORK_POLYGON = 1;
  BLOCKCHAIN_NETWORK_ETHEREUM = 2;
  BLOCKCHAIN_NETWORK_SOLANA = 3;
}

enum CertificationStatus {
  CERTIFICATION_STATUS_UNSPECIFIED = 0;
  CERTIFICATION_STATUS_PENDING = 1;          // Awaiting blockchain confirmation
  CERTIFICATION_STATUS_ISSUED = 2;
  CERTIFICATION_STATUS_REVOKED = 3;
}

// ============================================================================
// Messages
// ============================================================================

message Certification {
  string certification_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string user_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string skill_id = 3 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string skill_name = 4 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 100
    }
  ];
  CertificationType type = 5 [
    (buf.validate.field).enum.defined_only = true
  ];
  CertificationStatus status = 6 [
    (buf.validate.field).enum.defined_only = true
  ];

  // Blockchain info
  BlockchainNetwork blockchain = 7 [
    (buf.validate.field).enum.defined_only = true
  ];
  string contract_address = 8 [
    (buf.validate.field).string.max_len = 100
  ];
  string token_id = 9 [                      // NFT token ID
    (buf.validate.field).string.max_len = 100
  ];
  string transaction_hash = 10 [
    (buf.validate.field).string.max_len = 100
  ];

  // Certificate details
  string issuer_id = 11 [                    // User or platform who issued
    (buf.validate.field).string.max_len = 50
  ];
  string issuer_name = 12 [
    (buf.validate.field).string.max_len = 100
  ];
  string badge_image_url = 13 [
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
  string certificate_url = 14 [              // Shareable certificate page
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
  map<string, string> metadata = 15 [        // Additional data
    (buf.validate.field).map.max_pairs = 20,
    (buf.validate.field).map.keys = {
      string: {
        min_len: 1
        max_len: 32
      }
    },
    (buf.validate.field).map.values = {
      string: {
        max_len: 200
      }
    }
  ];

  // Timestamps
  google.protobuf.Timestamp issued_at = 16;
  google.protobuf.Timestamp expires_at = 17; // Optional expiration
  google.protobuf.Timestamp revoked_at = 18;
}

message BadgeTemplate {
  string template_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string name = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 100
    }
  ];
  string description = 3 [
    (buf.validate.field).string.max_len = 1000
  ];
  string image_url = 4 [
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
  CertificationType type = 5 [
    (buf.validate.field).enum.defined_only = true
  ];
  map<string, string> requirements = 6 [     // What's needed to earn it
    (buf.validate.field).map.max_pairs = 20,
    (buf.validate.field).map.keys = {
      string: {
        min_len: 1
        max_len: 32
      }
    },
    (buf.validate.field).map.values = {
      string: {
        max_len: 200
      }
    }
  ];
}

// ============================================================================
// Issue Certification
// ============================================================================

message IssueCertificationRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string skill_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string session_id = 3 [                    // Optional reference
    (buf.validate.field).string.max_len = 50
  ];
  string issuer_id = 4 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  CertificationType type = 5 [
    (buf.validate.field).enum.defined_only = true
  ];
  string template_id = 6 [                   // Badge template
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  bool mint_as_nft = 7;                      // Mint on blockchain
  BlockchainNetwork blockchain = 8 [
    (buf.validate.field).enum.defined_only = true
  ];
}

message IssueCertificationResponse {
  Certification certification = 1;
  string share_url = 2 [                     // Public certificate URL
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
  bool blockchain_pending = 3;               // If NFT minting in progress
}

// ============================================================================
// Verify Certification
// ============================================================================

message VerifyCertificationRequest {
  string certification_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string verification_code = 2 [             // Optional for QR code scans
    (buf.validate.field).string.max_len = 100
  ];
}

message VerifyCertificationResponse {
  Certification certification = 1;
  bool is_valid = 2;
  string blockchain_proof_url = 3 [          // Link to blockchain explorer
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
  string message = 4 [
    (buf.validate.field).string.max_len = 200
  ];
}

// ============================================================================
// Get User Certifications
// ============================================================================

message GetUserCertificationsRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  int32 page_size = 2 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 100
    }
  ];
  string page_token = 3 [
    (buf.validate.field).string.max_len = 256
  ];
  CertificationType type_filter = 4 [
    (buf.validate.field).enum.defined_only = true
  ];
  bool include_revoked = 5;
}

message GetUserCertificationsResponse {
  repeated Certification certifications = 1;
  string next_page_token = 2 [
    (buf.validate.field).string.max_len = 256
  ];
  int32 total_count = 3 [
    (buf.validate.field).int32.gte = 0
  ];
}

// ============================================================================
// Revoke Certification
// ============================================================================

message RevokeCertificationRequest {
  string certification_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string admin_id = 2 [                      // Admin performing revocation
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reason = 3 [
    (buf.validate.field).string.max_len = 500
  ];
}

message RevokeCertificationResponse {
  Certification certification = 1;
  bool blockchain_updated = 2;
}

// ============================================================================
// Get Certification
// ============================================================================

message GetCertificationRequest {
  string certification_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
}

message GetCertificationResponse {
  Certification certification = 1;
  skillsphere.common.v1.User user = 2;
  skillsphere.common.v1.Skill skill = 3;
}

// ============================================================================
// Share Certification
// ============================================================================

message ShareCertificationRequest {
  string certification_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  repeated string platforms = 2 [            // "linkedin", "twitter", "email"
    (buf.validate.field).repeated.max_items = 10,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
}

message ShareCertificationResponse {
  string public_url = 1 [
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
  map<string, string> share_links = 2 [      // Platform-specific share URLs
    (buf.validate.field).map.max_pairs = 20,
    (buf.validate.field).map.keys = {
      string: {
        min_len: 1
        max_len: 50
      }
    },
    (buf.validate.field).map.values = {
      string: {
        uri: true
        max_len: 2048
      }
    }
  ];
  string qr_code_url = 3 [                   // QR code image
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
}

// ============================================================================
// Mint NFT Badge
// ============================================================================

message MintNFTBadgeRequest {
  string certification_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string user_wallet_address = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 128
    }
  ];
  BlockchainNetwork blockchain = 3 [
    (buf.validate.field).enum.defined_only = true
  ];
}

message MintNFTBadgeResponse {
  string transaction_hash = 1 [
    (buf.validate.field).string.max_len = 100
  ];
  string token_id = 2 [
    (buf.validate.field).string.max_len = 100
  ];
  string contract_address = 3 [
    (buf.validate.field).string.max_len = 100
  ];
  string opensea_url = 4 [                   // Link to view on OpenSea
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
  google.protobuf.Timestamp minted_at = 5;
}

// ============================================================================
// Get Badge Templates
// ============================================================================

message GetBadgeTemplatesRequest {
  CertificationType type_filter = 1 [
    (buf.validate.field).enum.defined_only = true
  ];
  int32 limit = 2 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 100
    }
  ];
}

message GetBadgeTemplatesResponse {
  repeated BadgeTemplate templates = 1 [
    (buf.validate.field).repeated.max_items = 100
  ];
}
