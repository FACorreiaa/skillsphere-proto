syntax = "proto3";

package skillsphere.user.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/field_mask.proto";
import "common/v1/common.proto";
import "buf/validate/validate.proto";

option go_package = "github.com/FACorreiaa/skillsphere-proto/gen/go/user/v1;userv1";

// UserService manages user profiles, account operations, and preferences
service UserService {
  // Create a new user account
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);

  // Get user profile by ID
  rpc GetUser(GetUserRequest) returns (GetUserResponse);

  // Get multiple users by IDs (batch operation)
  rpc BatchGetUsers(BatchGetUsersRequest) returns (BatchGetUsersResponse);

  // Update user profile
  rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse);

  // Delete user account (soft delete)
  rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse);

  // List users with pagination and filters
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);

  // Get user statistics
  rpc GetUserStats(GetUserStatsRequest) returns (GetUserStatsResponse);

  // Update user availability
  rpc UpdateAvailability(UpdateAvailabilityRequest) returns (UpdateAvailabilityResponse);

  // Update notification preferences
  rpc UpdateNotificationPreferences(UpdateNotificationPreferencesRequest) returns (UpdateNotificationPreferencesResponse);

  // Get user's session history
  rpc GetUserSessions(GetUserSessionsRequest) returns (GetUserSessionsResponse);

  // Get user's ratings and reviews
  rpc GetUserRatings(GetUserRatingsRequest) returns (GetUserRatingsResponse);

  // Verify user account (for premium features)
  rpc VerifyUser(VerifyUserRequest) returns (VerifyUserResponse);
}

// ============================================================================
// Create User
// ============================================================================

message CreateUserRequest {
  string email = 1 [
    (buf.validate.field).string = {
      email: true
      max_len: 254
    }
  ];
  string username = 2 [
    (buf.validate.field).string = {
      min_len: 3
      max_len: 30
    }
  ];
  string password = 3 [                 // Will be hashed on server
    (buf.validate.field).string = {
      min_len: 8
      max_len: 128
    }
  ];
  string display_name = 4 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 100
    }
  ];
  string bio = 5 [
    (buf.validate.field).string.max_len = 1000
  ];
  skillsphere.common.v1.Location location = 6;
}

message CreateUserResponse {
  skillsphere.common.v1.User user = 1;
  string access_token = 2 [             // JWT for immediate login
    (buf.validate.field).string = {
      min_len: 1
      max_len: 2048
    }
  ];
}

// ============================================================================
// Get User
// ============================================================================

message GetUserRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
}

message GetUserResponse {
  skillsphere.common.v1.User user = 1;
}

// ============================================================================
// Batch Get Users
// ============================================================================

message BatchGetUsersRequest {
  repeated string user_ids = 1 [        // Max 100
    (buf.validate.field).repeated = {
      min_items: 1
      max_items: 100
    },
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
}

message BatchGetUsersResponse {
  repeated skillsphere.common.v1.User users = 1;
  repeated string not_found_ids = 2 [   // IDs that don't exist
    (buf.validate.field).repeated.max_items = 100,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
}

// ============================================================================
// Update User
// ============================================================================

message UpdateUserRequest {
  skillsphere.common.v1.User user = 1 [(buf.validate.field).required = true];
  google.protobuf.FieldMask update_mask = 2 [ // e.g., "bio,avatar_url,location"
    (buf.validate.field).required = true
  ];
}

message UpdateUserResponse {
  skillsphere.common.v1.User user = 1;
}

// ============================================================================
// Delete User
// ============================================================================

message DeleteUserRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reason = 2 [                   // Optional reason for deletion
    (buf.validate.field).string.max_len = 500
  ];
}

message DeleteUserResponse {
  bool success = 1;
  string message = 2 [
    (buf.validate.field).string.max_len = 200
  ];
}

// ============================================================================
// List Users
// ============================================================================

message ListUsersRequest {
  int32 page_size = 1 [                 // Default 20, max 100
    (buf.validate.field).int32 = {
      gte: 1
      lte: 100
    }
  ];
  string page_token = 2 [               // Opaque cursor for pagination
    (buf.validate.field).string.max_len = 256
  ];
  skillsphere.common.v1.SearchFilters filters = 3;
  string sort_by = 4 [                  // e.g., "created_at", "rating", "sessions"
    (buf.validate.field).string.max_len = 50
  ];
  bool ascending = 5;                   // Default false (descending)
}

message ListUsersResponse {
  repeated skillsphere.common.v1.User users = 1;
  string next_page_token = 2 [
    (buf.validate.field).string.max_len = 256
  ];
  int32 total_count = 3 [
    (buf.validate.field).int32.gte = 0
  ];
}

// ============================================================================
// Get User Stats
// ============================================================================

message GetUserStatsRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
}

message GetUserStatsResponse {
  int32 total_sessions = 1 [(buf.validate.field).int32.gte = 0];
  int32 completed_sessions = 2 [(buf.validate.field).int32.gte = 0];
  int32 cancelled_sessions = 3 [(buf.validate.field).int32.gte = 0];
  int32 no_show_count = 4 [(buf.validate.field).int32.gte = 0];
  double average_rating = 5 [
    (buf.validate.field).double = {
      gte: 0
      lte: 5
    }
  ];
  int32 total_reviews = 6 [(buf.validate.field).int32.gte = 0];
  int32 skills_offered_count = 7 [(buf.validate.field).int32.gte = 0];
  int32 skills_wanted_count = 8 [(buf.validate.field).int32.gte = 0];
  int32 active_days = 9 [               // Days since last activity
    (buf.validate.field).int32.gte = 0
  ];
  google.protobuf.Timestamp member_since = 10;
}

// ============================================================================
// Update Availability
// ============================================================================

message UpdateAvailabilityRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  skillsphere.common.v1.Availability availability = 2 [
    (buf.validate.field).required = true
  ];
}

message UpdateAvailabilityResponse {
  skillsphere.common.v1.Availability availability = 1;
}

// ============================================================================
// Update Notification Preferences
// ============================================================================

message UpdateNotificationPreferencesRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  skillsphere.common.v1.NotificationPreferences preferences = 2 [
    (buf.validate.field).required = true
  ];
}

message UpdateNotificationPreferencesResponse {
  skillsphere.common.v1.NotificationPreferences preferences = 1;
}

// ============================================================================
// Get User Sessions
// ============================================================================

message GetUserSessionsRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  int32 page_size = 2 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 100
    }
  ];
  string page_token = 3 [
    (buf.validate.field).string.max_len = 256
  ];
  skillsphere.common.v1.SessionStatus status_filter = 4 [
    (buf.validate.field).enum.defined_only = true
  ];
}

message GetUserSessionsResponse {
  repeated Session sessions = 1;        // Simplified session for listing
  string next_page_token = 2 [
    (buf.validate.field).string.max_len = 256
  ];
}

message Session {
  string session_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string partner_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string partner_name = 3 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 100
    }
  ];
  repeated string skills = 4 [
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
  skillsphere.common.v1.SessionStatus status = 5 [
    (buf.validate.field).enum.defined_only = true
  ];
  google.protobuf.Timestamp scheduled_at = 6;
}

// ============================================================================
// Get User Ratings
// ============================================================================

message GetUserRatingsRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  int32 page_size = 2 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 100
    }
  ];
  string page_token = 3 [
    (buf.validate.field).string.max_len = 256
  ];
}

message GetUserRatingsResponse {
  repeated skillsphere.common.v1.Rating ratings = 1;
  string next_page_token = 2 [
    (buf.validate.field).string.max_len = 256
  ];
  double average_score = 3 [
    (buf.validate.field).double = {
      gte: 0
      lte: 5
    }
  ];
}

// ============================================================================
// Verify User
// ============================================================================

message VerifyUserRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string verification_method = 2 [      // e.g., "email", "phone", "document"
    (buf.validate.field).string = {
      min_len: 2
      max_len: 32
    }
  ];
  string verification_token = 3 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 512
    }
  ];
}

message VerifyUserResponse {
  bool verified = 1;
  string badge_url = 2 [                // URL to verification badge image
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
}
