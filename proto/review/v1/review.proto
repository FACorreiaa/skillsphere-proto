syntax = "proto3";

package skillsphere.review.v1;

import "google/protobuf/timestamp.proto";
import "common/v1/common.proto";
import "buf/validate/validate.proto";

option go_package = "github.com/FACorreiaa/skillsphere-proto/gen/go/review/v1;reviewv1";

// ReviewService handles asynchronous expert reviews of uploaded content
service ReviewService {
  // Request a review
  rpc RequestReview(RequestReviewRequest) returns (RequestReviewResponse);

  // Get review details
  rpc GetReview(GetReviewRequest) returns (GetReviewResponse);

  // Submit review (expert provides feedback)
  rpc SubmitReview(SubmitReviewRequest) returns (SubmitReviewResponse);

  // List available reviewers for a skill
  rpc ListReviewers(ListReviewersRequest) returns (ListReviewersResponse);

  // Get user's review requests
  rpc GetUserReviews(GetUserReviewsRequest) returns (GetUserReviewsResponse);

  // Get reviewer's pending reviews
  rpc GetPendingReviews(GetPendingReviewsRequest) returns (GetPendingReviewsResponse);

  // Accept review request
  rpc AcceptReviewRequest(AcceptReviewRequestRequest) returns (AcceptReviewRequestResponse);

  // Decline review request
  rpc DeclineReviewRequest(DeclineReviewRequestRequest) returns (DeclineReviewRequestResponse);

  // Rate review quality
  rpc RateReview(RateReviewRequest) returns (RateReviewResponse);

  // Request revision of review
  rpc RequestRevision(RequestRevisionRequest) returns (RequestRevisionResponse);
}

// ============================================================================
// Enums
// ============================================================================

enum ReviewStatus {
  REVIEW_STATUS_UNSPECIFIED = 0;
  REVIEW_STATUS_PENDING = 1;                 // Awaiting reviewer acceptance
  REVIEW_STATUS_ACCEPTED = 2;                // Reviewer working on it
  REVIEW_STATUS_IN_PROGRESS = 3;
  REVIEW_STATUS_COMPLETED = 4;
  REVIEW_STATUS_REVISION_REQUESTED = 5;
  REVIEW_STATUS_DECLINED = 6;
  REVIEW_STATUS_CANCELLED = 7;
}

enum ReviewType {
  REVIEW_TYPE_UNSPECIFIED = 0;
  REVIEW_TYPE_CODE_REVIEW = 1;
  REVIEW_TYPE_DESIGN_REVIEW = 2;
  REVIEW_TYPE_WRITING_REVIEW = 3;
  REVIEW_TYPE_VIDEO_REVIEW = 4;
  REVIEW_TYPE_PORTFOLIO_REVIEW = 5;
  REVIEW_TYPE_RESUME_REVIEW = 6;
}

enum ReviewDepth {
  REVIEW_DEPTH_UNSPECIFIED = 0;
  REVIEW_DEPTH_QUICK = 1;                    // 15-30 min, high-level
  REVIEW_DEPTH_STANDARD = 2;                 // 1-2 hours, detailed
  REVIEW_DEPTH_COMPREHENSIVE = 3;            // 3+ hours, in-depth
}

// ============================================================================
// Messages
// ============================================================================

message Review {
  string review_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string requester_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reviewer_id = 3 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string skill_id = 4 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];

  // Request details
  ReviewType type = 5 [
    (buf.validate.field).enum.defined_only = true
  ];
  ReviewDepth depth = 6 [
    (buf.validate.field).enum.defined_only = true
  ];
  string title = 7 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 150
    }
  ];
  string description = 8 [
    (buf.validate.field).string.max_len = 5000
  ];
  repeated skillsphere.common.v1.Attachment content = 9 [
    (buf.validate.field).repeated.max_items = 20
  ];
  repeated string specific_questions = 10 [
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 500
      }
    }
  ];

  // Pricing
  skillsphere.common.v1.Money price = 11;
  string payment_id = 12 [
    (buf.validate.field).string.max_len = 50
  ];

  // Timeline
  google.protobuf.Timestamp requested_at = 13;
  google.protobuf.Timestamp accepted_at = 14;
  google.protobuf.Timestamp deadline = 15;
  google.protobuf.Timestamp completed_at = 16;

  // Review content
  string feedback = 17 [
    (buf.validate.field).string.max_len = 5000
  ];
  repeated FeedbackSection sections = 18 [
    (buf.validate.field).repeated.max_items = 50
  ];
  repeated skillsphere.common.v1.Attachment attachments = 19 [
    (buf.validate.field).repeated.max_items = 10
  ];
  string video_feedback_url = 20 [           // Optional video walkthrough
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];

  // Ratings
  int32 requester_rating = 21 [              // Requester rates the review
    (buf.validate.field).int32 = {
      gte: 1
      lte: 5
    }
  ];
  string requester_comment = 22 [
    (buf.validate.field).string.max_len = 1000
  ];
  int32 reviewer_rating = 23 [               // Reviewer rates the experience
    (buf.validate.field).int32 = {
      gte: 1
      lte: 5
    }
  ];
  string reviewer_comment = 24 [
    (buf.validate.field).string.max_len = 1000
  ];

  // Status
  ReviewStatus status = 25 [
    (buf.validate.field).enum.defined_only = true
  ];
}

message FeedbackSection {
  string title = 1 [                         // e.g., "Code Quality", "Architecture"
    (buf.validate.field).string = {
      min_len: 1
      max_len: 100
    }
  ];
  string content = 2 [
    (buf.validate.field).string.max_len = 2000
  ];
  int32 rating = 3 [                         // 1-5 stars for this aspect
    (buf.validate.field).int32 = {
      gte: 1
      lte: 5
    }
  ];
  repeated string strengths = 4 [
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 200
      }
    }
  ];
  repeated string improvements = 5 [
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 200
      }
    }
  ];
  repeated string resources = 6 [            // Recommended learning resources
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 200
      }
    }
  ];
}

message Reviewer {
  skillsphere.common.v1.User user = 1;
  repeated string expertise = 2 [            // Skill IDs
    (buf.validate.field).repeated.max_items = 50,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 50
      }
    }
  ];
  double average_review_rating = 3 [
    (buf.validate.field).double = {
      gte: 0
      lte: 5
    }
  ];
  int32 total_reviews = 4 [(buf.validate.field).int32.gte = 0];
  int32 response_time_hours = 5 [            // Average time to accept
    (buf.validate.field).int32 = {
      gte: 0
      lte: 168
    }
  ];
  skillsphere.common.v1.Money hourly_rate = 6;
  repeated ReviewType review_types = 7 [
    (buf.validate.field).repeated.max_items = 10
  ];
  bool is_available = 8;
}

// ============================================================================
// Request Review
// ============================================================================

message RequestReviewRequest {
  string requester_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reviewer_id = 2 [                   // Specific reviewer or empty for matching
    (buf.validate.field).string.max_len = 50
  ];
  string skill_id = 3 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  ReviewType type = 4 [
    (buf.validate.field).enum.defined_only = true
  ];
  ReviewDepth depth = 5 [
    (buf.validate.field).enum.defined_only = true
  ];
  string title = 6 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 150
    }
  ];
  string description = 7 [
    (buf.validate.field).string.max_len = 5000
  ];
  repeated skillsphere.common.v1.Attachment content = 8 [
    (buf.validate.field).repeated.max_items = 20
  ];
  repeated string specific_questions = 9 [
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 500
      }
    }
  ];
  google.protobuf.Timestamp deadline = 10;
  string payment_method_id = 11 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 100
    }
  ];
}

message RequestReviewResponse {
  Review review = 1;
  skillsphere.common.v1.Money total_price = 2;
  string escrow_payment_id = 3 [
    (buf.validate.field).string.max_len = 50
  ];
}

// ============================================================================
// Get Review
// ============================================================================

message GetReviewRequest {
  string review_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
}

message GetReviewResponse {
  Review review = 1;
  skillsphere.common.v1.User requester = 2;
  skillsphere.common.v1.User reviewer = 3;
}

// ============================================================================
// Submit Review
// ============================================================================

message SubmitReviewRequest {
  string review_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reviewer_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string feedback = 3 [
    (buf.validate.field).string.max_len = 5000
  ];
  repeated FeedbackSection sections = 4 [
    (buf.validate.field).repeated.max_items = 50
  ];
  repeated skillsphere.common.v1.Attachment attachments = 5 [
    (buf.validate.field).repeated.max_items = 10
  ];
  string video_feedback_url = 6 [
    (buf.validate.field).string = {
      uri: true
      max_len: 2048
    }
  ];
}

message SubmitReviewResponse {
  Review review = 1;
  bool payment_released = 2;
}

// ============================================================================
// List Reviewers
// ============================================================================

message ListReviewersRequest {
  string skill_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  ReviewType type = 2 [
    (buf.validate.field).enum.defined_only = true
  ];
  skillsphere.common.v1.Money max_price = 3;
  int32 min_rating = 4 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 5
    }
  ];
  bool available_now = 5;
}

message ListReviewersResponse {
  repeated Reviewer reviewers = 1;
}

// ============================================================================
// Get User Reviews
// ============================================================================

message GetUserReviewsRequest {
  string user_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  bool as_requester = 2;
  bool as_reviewer = 3;
  ReviewStatus status = 4 [
    (buf.validate.field).enum.defined_only = true
  ];
}

message GetUserReviewsResponse {
  repeated Review requested_reviews = 1;
  repeated Review provided_reviews = 2;
}

// ============================================================================
// Get Pending Reviews
// ============================================================================

message GetPendingReviewsRequest {
  string reviewer_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
}

message GetPendingReviewsResponse {
  repeated Review pending_reviews = 1;
  int32 total_count = 2;
}

// ============================================================================
// Accept Review Request
// ============================================================================

message AcceptReviewRequestRequest {
  string review_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reviewer_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  google.protobuf.Timestamp estimated_completion = 3;
}

message AcceptReviewRequestResponse {
  Review review = 1;
}

// ============================================================================
// Decline Review Request
// ============================================================================

message DeclineReviewRequestRequest {
  string review_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reviewer_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string reason = 3 [
    (buf.validate.field).string.max_len = 500
  ];
}

message DeclineReviewRequestResponse {
  bool success = 1;
  bool refund_issued = 2;
}

// ============================================================================
// Rate Review
// ============================================================================

message RateReviewRequest {
  string review_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string user_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  int32 rating = 3 [
    (buf.validate.field).int32 = {
      gte: 1
      lte: 5
    }
  ];
  string comment = 4 [
    (buf.validate.field).string.max_len = 1000
  ];
}

message RateReviewResponse {
  Review review = 1;
}

// ============================================================================
// Request Revision
// ============================================================================

message RequestRevisionRequest {
  string review_id = 1 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string requester_id = 2 [
    (buf.validate.field).string = {
      min_len: 1
      max_len: 50
    }
  ];
  string revision_notes = 3 [
    (buf.validate.field).string.max_len = 2000
  ];
  repeated string specific_areas = 4 [
    (buf.validate.field).repeated.max_items = 20,
    (buf.validate.field).repeated.items = {
      string: {
        min_len: 1
        max_len: 200
      }
    }
  ];
}

message RequestRevisionResponse {
  Review review = 1;
  google.protobuf.Timestamp new_deadline = 2;
}
